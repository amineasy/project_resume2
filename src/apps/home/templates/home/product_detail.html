{% extends 'base.html' %}
{% load static %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/base.css' %}">
<link rel="stylesheet" href="{% static 'home/css/product_detail.css' %}">
{% endblock %}

{% block title %}{{ product.title }}{% endblock %}

{% block body %}
<div class="product-detail">

    <h1>{{ product.title }}</h1>
    <p>{{ product.description }}</p>

    <!-- علاقه‌مندی -->
    <form action="{% url 'home:product_favourite' product.id %}" method="post" class="favourite-form">
        {% csrf_token %}
        <button type="submit" class="favourite-btn">
            {% if is_favourite %}
                ❤️ حذف از علاقه‌مندی
            {% else %}
                🤍 افزودن به علاقه‌مندی
            {% endif %}
        </button>
    </form>

    <!-- رنگ -->
    {% if has_colors %}
    <div class="variant">
        <label for="color">رنگ:</label>
        <select id="color">
            <option value="">انتخاب کنید</option>
            {% for color in colors %}
                <option value="{{ color.color__id }}">{{ color.color__color }}</option>
            {% endfor %}
        </select>
    </div>
    {% endif %}

    <!-- سایز -->
    {% if has_sizes %}
    <div class="variant">
        <label for="size">سایز:</label>
        <select id="size">
            <option value="">انتخاب کنید</option>
            {% for size in sizes %}
                <option value="{{ size.size__id }}">{{ size.size__size }}</option>
            {% endfor %}
        </select>
    </div>
    {% endif %}

    <!-- قیمت -->
    <div class="price-box" id="price-box">
        {% if default_attribute %}
            {% if default_attribute.get_discount_price %}
                <span class="discount">{{ default_attribute.get_price }} تومان</span>
                <span class="price">{{ default_attribute.get_discount_price }} تومان</span>
            {% else %}
                <span class="price">{{ default_attribute.get_price }} تومان</span>
            {% endif %}
        {% else %}
            <span>قیمتی موجود نیست</span>
        {% endif %}
    </div>

    <!-- دکمه سبد خرید (فعلاً نمایشی) -->
    <button class="add-to-cart-btn">🛒 افزودن به سبد خرید</button>

</div>

<!-- اسکریپت تغییر قیمت -->
<script>
    const variantData = {{ variant_data|safe }};
    const colorSelect = document.getElementById('color');
    const sizeSelect = document.getElementById('size');
    const priceBox = document.getElementById('price-box');

    function updatePrice() {
        const selectedColor = colorSelect?.value || null;
        const selectedSize = sizeSelect?.value || null;

        const match = variantData.find(item =>
            (item.color_id == selectedColor || !selectedColor) &&
            (item.size_id == selectedSize || !selectedSize)
        );

        if (match) {
            priceBox.innerHTML = match.discount_price
                ? `<span class="discount">${match.price} تومان</span><span class="price">${match.discount_price} تومان</span>`
                : `<span class="price">${match.total_price} تومان</span>`;
        } else {
            priceBox.innerHTML = '<span>موجود نیست</span>';
        }
    }

    if (colorSelect) colorSelect.addEventListener('change', updatePrice);
    if (sizeSelect) sizeSelect.addEventListener('change', updatePrice);
</script>
{% endblock %}
